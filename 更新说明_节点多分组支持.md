# 更新说明：节点多分组支持

## 📅 更新时间
2025-10-10

## 🎯 更新内容
修复了订阅管理的分组功能"抢节点"问题，实现了节点可以同时属于多个分组的功能。

## 🔧 技术实现

### 1. 数据库模型修改
- **新增关联表**：`subscription_node` - 用于存储节点和订阅分组的多对多关系
- **修改 Node 模型**：添加 `subscriptions` 关系字段，支持一个节点属于多个订阅
- **修改 Subscription 模型**：将 `nodes` 关系从一对多改为多对多

### 2. API 修改
- **订阅节点管理 API** (`/api/subscriptions/<id>/nodes`)：
  - 使用多对多关系管理节点
  - 不再修改其他分组的节点
  
- **节点列表 API** (`/api/nodes`)：
  - 返回节点所属的所有订阅分组列表
  - 新增 `subscription_names` 和 `subscription_ids` 字段

### 3. 数据迁移
- 创建了 `migrate_to_many_to_many_nodes.py` 迁移脚本
- 自动将现有的节点-订阅关系迁移到新的多对多关系表
- 保留了原有的 `subscription_id` 字段以保持兼容性

## ✅ 功能验证

已通过自动化测试验证：
- ✅ 节点可以同时添加到多个分组
- ✅ 在一个分组中选择节点不会影响其他分组
- ✅ 删除分组时不会删除节点本身（只删除关联关系）
- ✅ 删除节点时会自动清理所有关联关系

## 📝 使用说明

### 对于新安装的系统
直接运行 `python app.py` 即可，系统会自动创建正确的数据库结构。

### 对于现有系统（已有数据）
如果您的系统已经有数据，运行应用程序时会自动初始化新的表结构。数据库模式更改会自动应用。

### 手动迁移（可选）
如果需要手动迁移现有数据，可以运行：
```bash
python migrate_to_many_to_many_nodes.py
```

## 🎉 使用效果

**之前的问题**：
- 一个节点只能属于一个分组
- 在分组B选择节点X后，分组A中的节点X会消失

**修复后**：
- 一个节点可以同时属于多个分组
- 在分组B选择节点X不会影响分组A中的节点X
- 节点列表显示每个节点所属的所有分组

## 📋 修改的文件

1. `models.py` - 数据库模型定义
2. `app.py` - API 逻辑修改
3. `migrate_to_many_to_many_nodes.py` - 数据迁移脚本（新增）
4. `README.md` - 更新功能说明

## 🔄 向后兼容性

- ✅ 保留了原有的 API 接口
- ✅ 保留了 `subscription_id` 字段
- ✅ 前端无需修改，完全兼容
- ✅ 现有配置和数据不受影响

## 🐛 已知问题

无

## 💡 建议

建议在使用前：
1. 备份数据库文件 `instance/clash_manager.db`
2. 测试功能是否正常工作
3. 如有问题，可恢复备份

---

**更新完成！现在您可以放心地将同一个节点添加到多个分组了。** 🎊

