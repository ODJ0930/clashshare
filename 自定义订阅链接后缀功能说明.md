# 自定义订阅链接后缀功能说明

## 功能概述

现在支持为用户和订阅分组设置**自定义链接后缀**，让订阅链接更加易记和个性化。

### 功能特点

✅ **双模式支持**：自定义后缀和系统生成的token都可以使用  
✅ **易于记忆**：可以设置如 `my-family`、`vip-user` 这样的易记后缀  
✅ **向后兼容**：原有的系统token链接继续有效  
✅ **安全验证**：自动检查后缀格式和唯一性  

## 使用方法

### 1. 为用户设置自定义后缀

1. 进入**用户管理**页面
2. 点击用户的**✏️ 编辑**按钮
3. 在**自定义链接后缀**字段输入你想要的后缀
4. 点击**保存**

#### 格式要求
- 只能包含：字母、数字、下划线（_）、中划线（-）
- 示例：`my-custom-link`、`user_001`、`family-sub`

### 2. 链接示例对比

**原有系统链接（继续可用）：**
```
https://dychange.527930.xyz/sub/user/7AWeu6YdLp_ey1pn49zQgIjNPNDMuueo3liQgUjMq9M
```

**自定义后缀链接（新功能）：**
```
https://dychange.527930.xyz/sub/user/my-custom-link
```

### 3. 如何识别自定义链接

在用户管理页面的订阅链接列，使用自定义后缀的链接会显示 **🔗** 图标。

## 数据库迁移

如果你已经有运行中的系统，需要执行数据库迁移：

```bash
python migrate_add_custom_slug.py
```

迁移脚本会：
- 为 `users` 表添加 `custom_slug` 字段
- 为 `subscriptions` 表添加 `custom_slug` 字段
- 创建唯一索引保证后缀不重复
- 保留所有现有数据

## 技术实现

### 后端变更（app.py）

1. **订阅路由支持双模式查找**：
   ```python
   # 先尝试自定义后缀，再尝试系统token
   user = User.query.filter_by(custom_slug=token).first()
   if not user:
       user = User.query.filter_by(subscription_token=token).first()
   ```

2. **API 返回自定义后缀**：
   - `/api/users` 接口增加 `custom_slug` 字段
   - `/api/subscriptions` 接口增加 `custom_slug` 字段

3. **更新用户时验证后缀**：
   - 格式验证：只允许 `[a-zA-Z0-9_-]+`
   - 唯一性验证：检查是否已被使用

### 数据库变更（models.py）

```python
class User(db.Model):
    # ...
    custom_slug = db.Column(db.String(100), unique=True, nullable=True)
    
class Subscription(db.Model):
    # ...
    custom_slug = db.Column(db.String(100), unique=True, nullable=True)
```

### 前端变更

1. **dashboard.html**：
   - 编辑用户模态框增加"自定义链接后缀"输入框

2. **dashboard.js**：
   - `loadUsers()` - 显示自定义后缀URL
   - `showEditUserModal()` - 填充自定义后缀
   - `saveUserEdit()` - 保存并验证自定义后缀

## 使用场景

### 场景 1：家庭用户分享
设置后缀为 `family`，链接变成：
```
https://your-domain/sub/user/family
```

### 场景 2：VIP 客户专属
设置后缀为 `vip-premium`，链接变成：
```
https://your-domain/sub/user/vip-premium
```

### 场景 3：测试环境
设置后缀为 `test-user`，链接变成：
```
https://your-domain/sub/user/test-user
```

## 注意事项

⚠️ **重要提示**：

1. 自定义后缀一旦设置，旧的系统token链接仍然可用
2. 后缀必须唯一，不能与其他用户/订阅重复
3. 留空自定义后缀字段将继续使用系统生成的token
4. 修改自定义后缀后，新的链接立即生效

## 常见问题

**Q: 设置自定义后缀后，原来的链接还能用吗？**  
A: 可以！原有的系统token链接继续有效，不会失效。

**Q: 可以修改已设置的自定义后缀吗？**  
A: 可以，随时可以修改或清空。

**Q: 自定义后缀可以包含中文吗？**  
A: 不可以，只支持英文字母、数字、下划线和中划线。

**Q: 如果设置的后缀已被其他用户使用怎么办？**  
A: 系统会提示"该自定义后缀已被使用"，请换一个后缀。

## 更新日志

**版本：2024-10-10**
- ✨ 新增用户自定义订阅链接后缀功能
- ✨ 新增订阅分组自定义链接后缀功能
- ✨ 支持自定义后缀和系统token双模式访问
- ✨ 前端显示自定义链接图标标识
- 🔧 添加自定义后缀格式和唯一性验证
- 📝 提供数据库迁移脚本

